<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>กิจกรรมวันแม่ - แสดงความรักให้แม่</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'line-green': '#06C755',
                        'pink-mother': '#FF69B4'
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gradient-to-br from-pink-50 to-pink-100 min-h-screen">
    <!-- Header -->
    <div class="bg-gradient-to-r from-pink-mother to-red-400 text-white p-4 shadow-lg">
        <div class="container mx-auto text-center">
            <i class="fas fa-heart text-3xl mb-2"></i>
            <h1 class="text-2xl font-bold">กิจกรรมวันแม่</h1>
            <p class="text-sm opacity-90">แสดงความรักให้แม่ผ่านผลิตภัณฑ์ของเรา</p>
        </div>
    </div>

    <!-- Profile Section -->
    <div id="profileSection" class="container mx-auto p-4 hidden">
        <div class="bg-white rounded-lg shadow-md p-4 mb-4">
            <div class="flex items-center space-x-4">
                <img id="profilePicture" src="" alt="Profile" class="w-16 h-16 rounded-full">
                <div>
                    <h3 id="displayName" class="font-bold text-lg"></h3>
                    <p id="userId" class="text-gray-500 text-sm"></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Form -->
    <div class="container mx-auto p-4">
        <form id="mothersDayForm" class="bg-white rounded-lg shadow-lg p-6">
            <!-- Product Image Upload -->
            <div class="mb-6">
                <label class="block text-gray-700 text-sm font-bold mb-2">
                    <i class="fas fa-camera mr-2"></i>อัปโหลดรูปผลิตภัณฑ์
                </label>
                <div class="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center">
                    <input type="file" id="productImage" accept="image/*" class="hidden">
                    <div id="uploadArea" class="cursor-pointer" onclick="document.getElementById('productImage').click()">
                        <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-2"></i>
                        <p class="text-gray-500">คลิกเพื่อเลือกรูปภาพ</p>
                    </div>
                    <div id="imagePreview" class="hidden">
                        <img id="previewImg" src="" alt="Preview" class="max-w-full h-40 mx-auto rounded">
                        <p class="text-sm text-gray-500 mt-2">คลิกเพื่อเปลี่ยนรูป</p>
                    </div>
                </div>
            </div>

            <!-- Love Message -->
            <div class="mb-6">
                <label for="loveMessage" class="block text-gray-700 text-sm font-bold mb-2">
                    <i class="fas fa-heart mr-2"></i>ข้อความบอกรักแม่
                </label>
                <textarea id="loveMessage" rows="4" 
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-pink-mother resize-none"
                    placeholder="เขียนข้อความบอกรักแม่ของคุณ..."></textarea>
                <p class="text-sm text-gray-500 mt-1">
                    <span id="charCount">0</span>/200 ตัวอักษร
                </p>
            </div>

            <!-- Product Name -->
            <div class="mb-6">
                <label for="productName" class="block text-gray-700 text-sm font-bold mb-2">
                    <i class="fas fa-tag mr-2"></i>ชื่อผลิตภัณฑ์ที่ซื้อ
                </label>
                <input type="text" id="productName" 
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-pink-mother"
                    placeholder="ระบุชื่อผลิตภัณฑ์">
            </div>

            <!-- Contact Info -->
            <div class="mb-6">
                <label for="phoneNumber" class="block text-gray-700 text-sm font-bold mb-2">
                    <i class="fas fa-phone mr-2"></i>เบอร์โทรศัพท์
                </label>
                <input type="tel" id="phoneNumber" 
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-pink-mother"
                    placeholder="เบอร์โทรศัพท์สำหรับติดต่อ">
            </div>

            <!-- Submit Button -->
            <button type="submit" id="submitBtn" 
                class="w-full bg-gradient-to-r from-pink-mother to-red-400 text-white font-bold py-3 px-4 rounded-lg hover:from-pink-600 hover:to-red-500 transition duration-300">
                <i class="fas fa-paper-plane mr-2"></i>ส่งข้อมูล
            </button>
        </form>

        <!-- Share Section -->
        <div id="shareSection" class="hidden mt-6 bg-white rounded-lg shadow-lg p-6">
            <h3 class="text-lg font-bold mb-4 text-center">
                <i class="fas fa-share-alt mr-2"></i>แชร์ความรักให้แม่
            </h3>
            
            <div class="space-y-4">
                <!-- LINE Share -->
                <button id="shareLineBtn" 
                    class="w-full bg-line-green text-white font-bold py-3 px-4 rounded-lg hover:bg-green-600 transition duration-300">
                    <i class="fab fa-line mr-2"></i>แชร์ใน LINE
                </button>

                <!-- Facebook Share -->
                <button id="shareFacebookBtn" 
                    class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition duration-300">
                    <i class="fab fa-facebook-f mr-2"></i>แชร์ใน Facebook
                </button>
            </div>
        </div>

        <!-- Admin Panel -->
        <div id="adminPanel" class="hidden mt-6 bg-white rounded-lg shadow-lg p-6">
            <h3 class="text-lg font-bold mb-4">
                <i class="fas fa-cog mr-2"></i>ตรวจสอบข้อมูล
            </h3>
            <button id="viewDataBtn" 
                class="w-full bg-gray-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-gray-700 transition duration-300">
                <i class="fas fa-table mr-2"></i>ดูข้อมูลทั้งหมด
            </button>
        </div>
    </div>

    <!-- Loading Modal -->
    <div id="loadingModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
        <div class="bg-white p-6 rounded-lg">
            <div class="text-center">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-pink-mother mx-auto mb-4"></div>
                <p>กำลังบันทึกข้อมูล...</p>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let liffProfile = null;
        let selectedImage = null;
        let submissionData = null;
        
        // LIFF Configuration
        const LIFF_ID = '1657132355-ZdM6EdWK'; // ใส่ LIFF ID ของคุณ
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbwuAgmG-CK6_pd0Syh6Le67pQXX8z39FABhP2P1lZzSqtFvEVoijTOnDQ0y_VF2q0TznQ/exec';
        const HASHTAGS = '#วันแม่2025 #แสดงความรักแม่ #รักแม่ #MothersDay2025';

        // Initialize LIFF
        window.onload = function() {
            initializeLiff();
            setupEventListeners();
        };

        async function initializeLiff() {
            try {
                await liff.init({ liffId: LIFF_ID });
                
                if (liff.isLoggedIn()) {
                    await loadProfile();
                } else {
                    liff.login();
                }
            } catch (error) {
                console.error('LIFF initialization failed:', error);
                // For testing without LIFF
                document.getElementById('profileSection').classList.remove('hidden');
                document.getElementById('displayName').textContent = 'ผู้ใช้ทดสอบ';
                document.getElementById('userId').textContent = 'test-user-id';
            }
        }

        async function loadProfile() {
            try {
                const profile = await liff.getProfile();
                liffProfile = profile;
                
                document.getElementById('profilePicture').src = profile.pictureUrl || '';
                document.getElementById('displayName').textContent = profile.displayName;
                document.getElementById('userId').textContent = profile.userId;
                document.getElementById('profileSection').classList.remove('hidden');
            } catch (error) {
                console.error('Failed to load profile:', error);
            }
        }

        function setupEventListeners() {
            // Image upload
            document.getElementById('productImage').addEventListener('change', handleImageUpload);
            
            // Character count for message
            document.getElementById('loveMessage').addEventListener('input', updateCharCount);
            
            // Form submission
            document.getElementById('mothersDayForm').addEventListener('submit', handleSubmit);
            
            // Share buttons
            document.getElementById('shareLineBtn').addEventListener('click', shareToLine);
            document.getElementById('shareFacebookBtn').addEventListener('click', shareToFacebook);
            
            // Admin panel
            document.getElementById('viewDataBtn').addEventListener('click', viewAllData);
        }

        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (file) {
                selectedImage = file;
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('previewImg').src = e.target.result;
                    document.getElementById('uploadArea').classList.add('hidden');
                    document.getElementById('imagePreview').classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            }
        }

        function updateCharCount() {
            const message = document.getElementById('loveMessage').value;
            document.getElementById('charCount').textContent = message.length;
        }

        async function handleSubmit(event) {
            event.preventDefault();
            
            const productName = document.getElementById('productName').value;
            const loveMessage = document.getElementById('loveMessage').value;
            const phoneNumber = document.getElementById('phoneNumber').value;

            if (!selectedImage || !productName || !loveMessage || !phoneNumber) {
                alert('กรุณากรอกข้อมูลให้ครบถ้วน');
                return;
            }

            showLoading(true);

            try {
                // Prepare form data
                const formData = new FormData();
                formData.append('action', 'submit');
                formData.append('userId', liffProfile?.userId || 'test-user');
                formData.append('displayName', liffProfile?.displayName || 'ผู้ใช้ทดสอบ');
                formData.append('pictureUrl', liffProfile?.pictureUrl || '');
                formData.append('productName', productName);
                formData.append('loveMessage', loveMessage);
                formData.append('phoneNumber', phoneNumber);
                formData.append('productImage', selectedImage);
                formData.append('timestamp', new Date().toISOString());

                // Submit to Google Apps Script
                const response = await fetch(GAS_URL, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                
                if (result.success) {
                    submissionData = {
                        productName,
                        loveMessage,
                        phoneNumber,
                        imageUrl: result.imageUrl,
                        displayName: liffProfile?.displayName || 'ผู้ใช้ทดสอบ'
                    };

                    // Send message to LINE chat
                    await sendMessageToLine();
                    
                    // Show share section
                    document.getElementById('shareSection').classList.remove('hidden');
                    document.getElementById('mothersDayForm').style.display = 'none';
                    
                    alert('บันทึกข้อมูลสำเร็จ!');
                } else {
                    throw new Error(result.error || 'เกิดข้อผิดพลาด');
                }
            } catch (error) {
                console.error('Submission error:', error);
                alert('เกิดข้อผิดพลาดในการบันทึกข้อมูล');
            } finally {
                showLoading(false);
            }
        }

        async function sendMessageToLine() {
            if (!liff.isApiAvailable('sendMessages') || !submissionData) return;

            const message = {
                type: 'flex',
                altText: 'ข้อความวันแม่',
                contents: {
                    type: 'bubble',
                    header: {
                        type: 'box',
                        layout: 'vertical',
                        contents: [
                            {
                                type: 'text',
                                text: '💖 ข้อความวันแม่',
                                weight: 'bold',
                                color: '#FF69B4'
                            }
                        ]
                    },
                    body: {
                        type: 'box',
                        layout: 'vertical',
                        contents: [
                            {
                                type: 'text',
                                text: `ผลิตภัณฑ์: ${submissionData.productName}`,
                                wrap: true,
                                margin: 'md'
                            },
                            {
                                type: 'text',
                                text: `ข้อความ: ${submissionData.loveMessage}`,
                                wrap: true,
                                margin: 'md'
                            }
                        ]
                    }
                }
            };

            try {
                await liff.sendMessages([message]);
            } catch (error) {
                console.error('Failed to send message:', error);
            }
        }

        function shareToLine() {
            if (!submissionData) return;
            
            const shareText = `💖 ${submissionData.loveMessage}\n\nผลิตภัณฑ์: ${submissionData.productName}\n\n${HASHTAGS}`;
            
            if (liff.isApiAvailable('shareTargetPicker')) {
                liff.shareTargetPicker([{
                    type: 'text',
                    text: shareText
                }]);
            } else {
                // Fallback: copy to clipboard
                navigator.clipboard.writeText(shareText);
                alert('คัดลอกข้อความแล้ว กรุณาไปแชร์ใน LINE');
            }
        }

        function shareToFacebook() {
            if (!submissionData) return;
            
            const shareText = `${submissionData.loveMessage}\n\nผลิตภัณฑ์: ${submissionData.productName}\n\n${HASHTAGS}`;
            const fbUrl = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(window.location.href)}&quote=${encodeURIComponent(shareText)}`;
            
            // Track Facebook share
            trackFacebookShare(fbUrl);
            
            window.open(fbUrl, '_blank', 'width=600,height=400');
        }

        async function trackFacebookShare(shareUrl) {
            try {
                const formData = new FormData();
                formData.append('action', 'trackShare');
                formData.append('userId', liffProfile?.userId || 'test-user');
                formData.append('platform', 'facebook');
                formData.append('shareUrl', shareUrl);
                formData.append('timestamp', new Date().toISOString());

                await fetch(GAS_URL, {
                    method: 'POST',
                    body: formData
                });
            } catch (error) {
                console.error('Failed to track share:', error);
            }
        }

        async function viewAllData() {
            try {
                const response = await fetch(`${GAS_URL}?action=viewData`);
                const data = await response.json();
                
                if (data.success) {
                    const tableHtml = generateDataTable(data.data);
                    const newWindow = window.open('', '_blank');
                    newWindow.document.write(`
                        <html>
                        <head>
                            <title>ข้อมูลกิจกรรมวันแม่</title>
                            <style>
                                body { font-family: Arial, sans-serif; padding: 20px; }
                                table { width: 100%; border-collapse: collapse; }
                                th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                                th { background-color: #FF69B4; color: white; }
                                img { max-width: 100px; height: auto; }
                            </style>
                        </head>
                        <body>
                            <h1>ข้อมูลกิจกรรมวันแม่</h1>
                            ${tableHtml}
                        </body>
                        </html>
                    `);
                }
            } catch (error) {
                console.error('Failed to view data:', error);
                alert('เกิดข้อผิดพลาดในการโหลดข้อมูล');
            }
        }

        function generateDataTable(data) {
            if (!data || data.length === 0) {
                return '<p>ไม่มีข้อมูล</p>';
            }

            let html = '<table><thead><tr>';
            html += '<th>วันที่</th><th>ชื่อ</th><th>ผลิตภัณฑ์</th><th>ข้อความ</th><th>โทรศัพท์</th><th>รูปภาพ</th><th>การแชร์</th>';
            html += '</tr></thead><tbody>';

            data.forEach(row => {
                html += '<tr>';
                html += `<td>${row.timestamp || ''}</td>`;
                html += `<td>${row.displayName || ''}</td>`;
                html += `<td>${row.productName || ''}</td>`;
                html += `<td>${row.loveMessage || ''}</td>`;
                html += `<td>${row.phoneNumber || ''}</td>`;
                html += `<td>${row.imageUrl ? `<img src="${row.imageUrl}" alt="Product">` : ''}</td>`;
                html += `<td>${row.shareCount || 0} ครั้ง</td>`;
                html += '</tr>';
            });

            html += '</tbody></table>';
            return html;
        }

        function showLoading(show) {
            const modal = document.getElementById('loadingModal');
            if (show) {
                modal.classList.remove('hidden');
            } else {
                modal.classList.add('hidden');
            }
        }

        // Show admin panel for specific users (you can modify this condition)
        if (liffProfile?.userId === 'admin-user-id') {
            document.getElementById('adminPanel').classList.remove('hidden');
        }
    </script>
</body>
</html>
